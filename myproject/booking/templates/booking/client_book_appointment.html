{% extends 'base.html' %}
{% load dict_extras time_extras %}

{% block title %}Запись к {{ specialist.first_name }} {{ specialist.last_name }}{% endblock %}

{% block content %}
<div class="container my-4">
  <div class="d-flex justify-content-between align-items-start mb-3">
    <div>
      <h2 class="mb-1">Запись к
        {% with username=specialist.showcase.workshop.user.username|default:"" %}
          {% if username %}
            <a href="{% url 'showcase:specialist_detail' username specialist.pk %}" class="text-decoration-none">
              {{ specialist.first_name }} {{ specialist.last_name }}
            </a>
          {% else %}
            {{ specialist.first_name }} {{ specialist.last_name }}
          {% endif %}
        {% endwith %}
      </h2>
      <div class="small text-muted">
        {% if specialist.position %}{{ specialist.position }} ·{% endif %}
        {% if specialist.phone %} Тел: {{ specialist.phone }}{% endif %}
      </div>
    </div>

    <div class="text-end">
      <a href="{% url 'showcase:specialists_list' specialist.showcase.workshop.user.username %}"
         class="btn btn-outline-secondary btn-sm">Витрина</a>
      {% if specialist.showcase and specialist.showcase.workshop.user == request.user %}
        <a href="{% url 'booking:owner_schedule_manage' pk=specialist.pk %}" class="btn btn-outline-primary btn-sm">Управление расписанием</a>
      {% endif %}
    </div>
  </div>

  {% if messages %}
    <div class="mb-3">
      {% for message in messages %}
        <div class="alert alert-{{ message.tags|default:'info' }}">{{ message }}</div>
      {% endfor %}
    </div>
  {% endif %}

  <div class="row">
    <!-- Слева — календарь -->
    <div class="col-lg-4 mb-3">
      <form method="get" class="d-flex gap-2 align-items-center mb-2">
        <label class="mb-0">Месяц</label>
        <input type="month" name="month" value="{{ year }}-{{ month|stringformat:'02d' }}" class="form-control w-auto">
        <button class="btn btn-secondary" type="submit">Показать</button>
      </form>

      <div class="card">
        <div class="card-body p-3">
          <div class="d-flex justify-content-between align-items-center mb-2">
            <strong>{{ month_name }} {{ year }}</strong>
            <small class="text-muted">Кликните на день</small>
          </div>

          <table class="table table-bordered mb-0 calendar-table small">
            <thead>
              <tr>
                {% for wd in weekdays %}
                  <th class="text-center p-1">{{ wd }}</th>
                {% endfor %}
              </tr>
            </thead>
            <tbody>
              {% for week in month_days_matrix %}
                <tr>
                  {% for day in week %}
                    {% if day == 0 %}
                      <td class="p-2" style="height:60px;background:#f8f9fa;"></td>
                    {% else %}
                      {% with cnt=day_counts|get_item:day %}
                        <td class="p-1 text-center" style="cursor:pointer;">
                          <a class="text-decoration-none d-block"
                             href="?month={{ year }}-{{ month|stringformat:'02d' }}&date={{ year }}-{{ month|stringformat:'02d' }}-{{ day|stringformat:'02d' }}">
                            <strong>{{ day }}</strong>
                          </a>
                          {% if cnt and cnt > 0 %}
                            <div class="small text-success">{{ cnt }} свободно</div>
                          {% endif %}
                        </td>
                      {% endwith %}
                    {% endif %}
                  {% endfor %}
                </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>

      <div class="mt-3">
        <button class="btn btn-outline-primary btn-sm"
                onclick="location.href='?date={{ today }}&month={{ year }}-{{ month|stringformat:'02d' }}'">Сегодня</button>
      </div>
    </div>

    <!-- Справа — слоты и форма записи -->
    <div class="col-lg-8">
      <div class="card mb-3">
        <div class="card-body">
          <h5 class="card-title mb-2">Свободные слоты
            {% if selected_date %}на {{ selected_date|date:"d.m.Y" }}{% endif %}
          </h5>

          {% if selected_date %}
            {% if availabilities %}
              <form method="post" class="mb-3">
                {% csrf_token %}
                <div class="list-group mb-3">
                  {% for avail in availabilities %}
                    <label class="list-group-item list-group-item-action d-flex justify-content-between align-items-center">
                      <div>
                        <div><strong>{{ avail.start_time|format_time }} — {{ avail.end_time|format_time }}</strong></div>
                        {% if avail.service %}
                          <div class="small text-muted">
                            {% if avail.service.activity_area %}{{ avail.service.activity_area.get_category_display }}: {% endif %}
                            {{ avail.service.service_name }}
                          </div>
                        {% endif %}
                      </div>
                      <input type="radio" name="availability" value="{{ avail.pk }}" required>
                    </label>
                  {% endfor %}
                </div>

                <div class="mb-3">
                  {{ form.notes.label_tag }}
                  {{ form.notes }}
                  {% if form.notes.errors %}
                    <div class="text-danger small">{{ form.notes.errors|join:", " }}</div>
                  {% endif %}
                </div>

                <div class="d-flex gap-2">
                  <button type="submit" name="book_submit" value="1" class="btn btn-primary">Записаться</button>
                  <a class="btn btn-outline-secondary" href="?month={{ year }}-{{ month|stringformat:'02d' }}">Отмена</a>
                </div>
              </form>
            {% else %}
              <div class="alert alert-info">Нет доступных слотов на выбранную дату.</div>
            {% endif %}
          {% else %}
            <div class="text-muted">Выберите дату в календаре, чтобы увидеть свободные слоты.</div>
          {% endif %}

          {% if error %}
            <div class="alert alert-danger mt-2">{{ error }}</div>
          {% endif %}
        </div>
      </div>

      <div class="card">
        <div class="card-body">
          <h5 class="card-title mb-2">Информация</h5>
          <p class="small text-muted mb-0">
            Вы выбираете готовые свободные слоты, которые созданы администратором или владельцем студии.
            Если слот занят, система сообщит вам при попытке записи.
          </p>
        </div>
      </div>
    </div>
  </div>
</div>
{% endblock %}
