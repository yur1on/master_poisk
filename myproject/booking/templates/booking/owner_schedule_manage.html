{% extends "base.html" %}
{% load dict_extras time_extras %}

{% block title %}Расписание — {{ specialist.first_name }}{% endblock %}

{% block content %}
<div class="container my-4">
  <div class="d-flex justify-content-between align-items-center mb-3">
    <h2>
      {% comment %}Ссылка на детальную страницу специалиста — берём username из showcase.workshop.user{% endcomment %}
      {% with username=specialist.showcase.workshop.user.username|default:"" %}
        {% if username %}
          <a href="{% url 'showcase:specialist_detail' username specialist.pk %}" class="text-decoration-none">
            {{ specialist.first_name }} {{ specialist.last_name }}
          </a>
        {% else %}
          {{ specialist.first_name }} {{ specialist.last_name }}
        {% endif %}
      {% endwith %}
    </h2>
    {% if is_owner %}
      <a class="btn btn-outline-secondary" href="{% url 'booking:owner_appointments_list' pk=specialist.pk %}">Просмотреть все записи</a>
    {% endif %}
  </div>

  <p class="small text-muted">
    Услуги ниже показывают только те позиции, которые назначены этому специалисту.
  </p>

  {% if specialist.services.exists %}
    <div class="mb-3">
      <strong>Услуги специалиста:</strong>
      {% for s in specialist.services.all %}
        <span class="badge bg-secondary me-1">{{ s.service_name }}</span>
      {% endfor %}
    </div>
  {% else %}
    <div class="alert alert-warning">У специалиста ещё не назначены услуги.</div>
  {% endif %}

  <div class="row mb-4">
    <!-- Левая колонка: календарь и слоты выбранного дня -->
    <div class="col-md-4">
      <form method="get" class="d-flex gap-2 align-items-center mb-2">
        <label class="mb-0">Месяц</label>
        <input type="month" name="month" value="{{ month }}" class="form-control w-auto">
        <button class="btn btn-secondary" type="submit">Показать</button>
      </form>

      <div class="card mb-3">
        <div class="card-body p-3">
          <div class="d-flex justify-content-between align-items-center mb-2">
            <strong>{{ month_name }} {{ year }}</strong>
            <small class="text-muted">Кликните на день</small>
          </div>

          <table class="table table-bordered mb-0 calendar-table small">
            <thead>
              <tr>
                {% for wd in weekdays %}
                  <th class="text-center p-1">{{ wd }}</th>
                {% endfor %}
              </tr>
            </thead>
            <tbody>
              {% for week in month_days_matrix %}
                <tr>
                  {% for day in week %}
                    {% if day == 0 %}
                      <td class="p-2" style="height:48px;background:#f8f9fa;"></td>
                    {% else %}
                      {% with counts=day_counts|get_item:day %}
                        {% if selected_date and selected_date.day == day and selected_date.month == month_num and selected_date.year == year %}
                          <td class="p-1 text-center bg-primary text-white" style="cursor:pointer;">
                            <a class="text-white text-decoration-none"
                               href="?month={{ year }}-{{ month_num|stringformat:'02d' }}&date={{ year }}-{{ month_num|stringformat:'02d' }}-{{ day|stringformat:'02d' }}">
                              {{ day }}
                            </a>
                            <div class="small">
                              {% if counts.slots > 0 %}<span class="text-success">{{ counts.slots }} свободно</span>{% endif %}
                              {% if counts.appts > 0 %}<span class="ms-1 text-warning">{{ counts.appts }} записей</span>{% endif %}
                            </div>
                          </td>
                        {% else %}
                          {% if counts.slots > 0 or counts.appts > 0 %}
                            <td class="p-1 text-center" style="cursor:pointer;background:#eefaf1;">
                              <a class="text-decoration-none"
                                 href="?month={{ year }}-{{ month_num|stringformat:'02d' }}&date={{ year }}-{{ month_num|stringformat:'02d' }}-{{ day|stringformat:'02d' }}">
                                {{ day }}
                              </a>
                              <div class="small">
                                {% if counts.slots > 0 %}<span class="text-success">{{ counts.slots }} свободно</span>{% endif %}
                                {% if counts.appts > 0 %}<span class="ms-1 text-warning">{{ counts.appts }} записей</span>{% endif %}
                              </div>
                            </td>
                          {% else %}
                            <td class="p-1 text-center" style="background:#f8f9fa;">{{ day }}</td>
                          {% endif %}
                        {% endif %}
                      {% endwith %}
                    {% endif %}
                  {% endfor %}
                </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>

      <div class="card">
        <div class="card-body p-3">
          {% if selected_date %}
            <div class="d-flex justify-content-between align-items-center mb-2">
              <strong>День: {{ selected_date|date:"d.m.Y" }}</strong>
              <small class="text-muted">{{ availabilities_day|length }} слотов · {{ appointments_day|length }} записей</small>
            </div>

            {% if availabilities_day %}
              <div class="mb-2"><strong>Свободные слоты</strong></div>
              <ul class="list-group mb-3" id="day-slots-list">
                {% for a in availabilities_day %}
                  <li class="list-group-item">
                    <div class="d-flex justify-content-between align-items-center">
                      <div>
                        <strong>{{ a.start_time|format_time }} — {{ a.end_time|format_time }}</strong>
                        {% if a.service %}
                          <div class="small text-muted mt-1">
                            {% if a.service.activity_area %}{{ a.service.activity_area.get_category_display }}: {% endif %}
                            {{ a.service.service_name }}
                          </div>
                        {% endif %}
                      </div>
                      <div class="d-flex gap-2">
                        {% if is_owner %}
                          <a href="#" class="btn btn-sm btn-outline-primary edit-slot-btn" data-avail-id="{{ a.pk }}">Редактировать</a>
                          <button type="button" class="btn btn-sm btn-outline-danger delete-slot-btn" data-avail-id="{{ a.pk }}">Удалить</button>
                        {% else %}
                          <form method="post" class="d-inline">
                            {% csrf_token %}
                            <input type="hidden" name="availability" value="{{ a.pk }}">
                            <button name="book_submit" value="1" class="btn btn-sm btn-primary">Записаться</button>
                          </form>
                        {% endif %}
                      </div>
                    </div>
                    {% if is_owner %}
                      <div class="owner-assign-form mt-2">
                        <form method="post" class="row g-2 align-items-end">
                          {% csrf_token %}
                          <input type="hidden" name="owner_assign_submit" value="1">
                          <input type="hidden" name="availability_id" value="{{ a.pk }}">
                          <div class="col-sm-3">
                            <input type="text" name="client_name" class="form-control form-control-sm" placeholder="Имя клиента" required>
                          </div>
                          <div class="col-sm-3">
                            <input type="text" name="client_phone" class="form-control form-control-sm" placeholder="Телефон" required>
                          </div>
                          <div class="col-sm-3">
                            <input type="text" name="client_city" class="form-control form-control-sm" placeholder="Город (опц.)">
                          </div>
                          <div class="col-sm-3">
                            <input type="text" name="notes" class="form-control form-control-sm" placeholder="Заметки (опц.)">
                          </div>
                          <div class="col-auto">
                            <button type="submit" class="btn btn-sm btn-success">Назначить</button>
                          </div>
                        </form>
                      </div>
                    {% endif %}
                  </li>
                {% endfor %}
              </ul>
            {% endif %}

            {% if appointments_day %}
              <div class="mb-2"><strong>Записи клиентов</strong></div>
              <ul class="list-group">
                {% for ap in appointments_day %}
                  <li class="list-group-item">
                    <div class="d-flex justify-content-between">
                      <div>
                        <div class="fw-bold">
                          {% if ap.client.name %}{{ ap.client.name }}{% elif ap.client.user.get_full_name %}{{ ap.client.user.get_full_name }}{% else %}{{ ap.client.user.username }}{% endif %}
                        </div>
                        <div class="small text-muted">
                          {% if ap.client.phone %}Тел: {{ ap.client.phone }}{% endif %}
                          {% if ap.client.city %}<span class="ms-2">Город: {{ ap.client.city }}</span>{% endif %}
                        </div>
                        <div class="mt-1">
                          <strong>{{ ap.availability.start_time|format_time }} — {{ ap.availability.end_time|format_time }}</strong>
                          {% if ap.service %}<span class="ms-2 text-muted">— {{ ap.service.service_name }}</span>{% endif %}
                        </div>
                      </div>
                      <div class="text-end">
                        {% if is_owner %}
                          {% if ap.status == 'pending' %}
                            <a href="{% url 'booking:owner_confirm_appointment' pk=ap.pk %}" class="btn btn-sm btn-success mb-1">Подтвердить</a>
                          {% endif %}
                          <a href="{% url 'booking:owner_cancel_appointment' pk=ap.pk %}" class="btn btn-sm btn-danger">Отменить</a>
                        {% else %}
                          <div class="small text-muted">{{ ap.get_status_display }}</div>
                        {% endif %}
                      </div>
                    </div>
                  </li>
                {% endfor %}
              </ul>
            {% endif %}
          {% else %}
            <div class="text-muted">Выберите день, чтобы увидеть слоты и записи.</div>
          {% endif %}
        </div>
      </div>
    </div>

    <!-- Правая колонка -->
    <div class="col-md-8">
      {% if is_owner %}
        <form method="post" id="formset-main" class="mb-3">
          {% csrf_token %}
          {{ formset.management_form }}
          {% for form in formset.forms %}
            <div class="card mb-2 p-3" id="avail-form-{{ form.instance.pk|default:'new' }}">
              {{ form.id }}
              <div class="row g-2">
                <div class="col-md-3">
                  <label class="form-label">{{ form.date.label }}</label>
                  {{ form.date }}
                </div>
                <div class="col-md-3">
                  <label class="form-label">{{ form.start_time.label }}</label>
                  {{ form.start_time }}
                </div>
                <div class="col-md-3">
                  <label class="form-label">{{ form.end_time.label }}</label>
                  {{ form.end_time }}
                </div>
                <div class="col-md-3">
                  <label class="form-label">{{ form.service.label }}</label>
                  {{ form.service }}
                </div>
              </div>
              <div class="mt-2">
                {% if form.DELETE %}
                  <div class="form-check">
                    {{ form.DELETE }} <label class="form-check-label ms-1">Удалить</label>
                  </div>
                {% endif %}
                {% if form.non_field_errors %}
                  <div class="text-danger small mt-2">{{ form.non_field_errors|join:", " }}</div>
                {% endif %}
              </div>
            </div>
          {% endfor %}

          <div class="d-flex gap-2">
            <button type="submit" name="formset_submit" value="1" class="btn btn-primary">Сохранить изменения</button>
            <a class="btn btn-outline-secondary" href="?month={{ month }}">Сбросить</a>
          </div>
        </form>
      {% else %}
        <div class="card mb-3">
          <div class="card-body">
            <h5 class="card-title">Запись к {{ specialist.first_name }} {{ specialist.last_name }}</h5>
            <p class="small text-muted mb-3">Найдите свободный слот в календаре слева и нажмите «Записаться» рядом со слотом.</p>
            {% if selected_date %}
              <div class="mb-3">
                <strong>Свободные слоты на {{ selected_date|date:"d.m.Y" }}:</strong>
                {% if availabilities_day %}
                  <ul class="list-group mt-2">
                    {% for a in availabilities_day %}
                      <li class="list-group-item d-flex justify-content-between align-items-center">
                        <div>
                          <strong>{{ a.start_time|format_time }} — {{ a.end_time|format_time }}</strong>
                          {% if a.service %}<div class="small text-muted">{{ a.service.service_name }}</div>{% endif %}
                        </div>
                        <form method="post" class="m-0">
                          {% csrf_token %}
                          <input type="hidden" name="availability" value="{{ a.pk }}">
                          <button name="book_submit" value="1" class="btn btn-sm btn-primary">Записаться</button>
                        </form>
                      </li>
                    {% endfor %}
                  </ul>
                {% else %}
                  <div class="alert alert-info mb-0">Нет доступных слотов на эту дату.</div>
                {% endif %}
              </div>
            {% else %}
              <div class="text-muted">Выберите дату в календаре слева.</div>
            {% endif %}
          </div>
        </div>
      {% endif %}
    </div>
  </div>

  <h3 class="mt-4">Текущее расписание (за месяц)</h3>
  <ul class="list-group mb-4">
    {% for a in availabilities %}
      <li class="list-group-item d-flex justify-content-between align-items-center">
        <div>
          <strong>{{ a.date|date:"d.m.Y" }}</strong>
          — <span>{{ a.start_time|format_time }} - {{ a.end_time|format_time }}</span>
          {% if a.service %}<div class="small text-muted">— {{ a.service.service_name }}</div>{% endif %}
        </div>
        <div class="small text-muted">{{ a.created_at|date:"d.m.Y H:i" }}</div>
      </li>
    {% empty %}
      <li class="list-group-item">Расписание пусто.</li>
    {% endfor %}
  </ul>
</div>

<style>
  .highlight { box-shadow: 0 0 0 3px rgba(66,133,244,0.18); transition: box-shadow 0.25s ease-in-out; }
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
  // edit-slot scroll
  document.querySelectorAll('.edit-slot-btn').forEach(function(btn){
    btn.addEventListener('click', function(e){
      e.preventDefault();
      var id = btn.dataset.availId;
      if (!id) return;
      var el = document.getElementById('avail-form-' + id);
      if (!el) { alert('Форма не найдена. Обновите страницу.'); return; }
      el.scrollIntoView({behavior: 'smooth', block: 'center'});
      el.classList.add('highlight');
      setTimeout(()=> el.classList.remove('highlight'), 2000);
    });
  });

  // delete-slot: отмечаем соответствующий DELETE чекбокс и отправляем форму
  document.querySelectorAll('.delete-slot-btn').forEach(function(btn){
    btn.addEventListener('click', function(){
      var id = btn.dataset.availId;
      if (!id) return;
      if (!confirm('Удалить слот?')) return;
      var card = document.getElementById('avail-form-' + id);
      if (!card) { alert('Форма не найдена.'); return; }
      var del = card.querySelector('input[type="checkbox"][name$="-DELETE"]');
      if (del) { del.checked = true; document.getElementById('formset-main').submit(); return; }
      alert('Чекбокс удаления не найден — проверьте, что formset был создан с can_delete=True.');
    });
  });
});
</script>

{% endblock %}
