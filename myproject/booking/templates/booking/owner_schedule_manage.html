{# booking/templates/booking/owner_schedule_manage.html #}
{% extends "base.html" %}
{% load dict_extras time_extras %}

{% block title %}Расписание — {{ specialist.first_name }}{% endblock %}

{% block content %}
<div class="container my-4">
  <h2>Расписание для {{ specialist.first_name }} {{ specialist.last_name }}</h2>

  <p class="small text-muted">
    Услуги ниже показывают только те позиции, которые назначены этому специалисту.
  </p>

  {% if specialist.services.exists %}
    <div class="mb-3">
      <strong>Услуги специалиста:</strong>
      {% for s in specialist.services.all %}
        <span class="badge bg-secondary me-1">{{ s.service_name }}</span>
      {% endfor %}
    </div>
  {% else %}
    <div class="alert alert-warning">У специалиста ещё не назначены услуги. Назначьте услуги на странице управления специалистом.</div>
  {% endif %}

  <div class="row mb-4">
    <!-- Левая колонка: календарь + слоты выбранного дня -->
    <div class="col-md-4">
      <form method="get" class="d-flex gap-2 align-items-center mb-2">
        <label class="mb-0">Месяц</label>
        <input type="month" name="month" value="{{ month }}" class="form-control w-auto">
        <button class="btn btn-secondary" type="submit">Показать</button>
      </form>

      <div class="card mb-3">
        <div class="card-body p-3">
          <div class="d-flex justify-content-between align-items-center mb-2">
            <strong>{{ month_name }} {{ year }}</strong>
            <small class="text-muted">Кликните на день</small>
          </div>

          <table class="table table-bordered mb-0 calendar-table small">
            <thead>
              <tr>
                {% for wd in weekdays %}
                  <th class="text-center p-1">{{ wd }}</th>
                {% endfor %}
              </tr>
            </thead>
            <tbody>
              {% for week in month_days_matrix %}
                <tr>
                  {% for day in week %}
                    {% if day == 0 %}
                      <td class="p-2" style="height:40px;background:#f8f9fa;"></td>
                    {% else %}
                      {% with count=day_counts|get_item:day %}
                        {% if selected_date and selected_date.day == day and selected_date.month == month_num and selected_date.year == year %}
                          <td class="p-1 text-center bg-primary text-white" style="cursor:pointer;">
                            <a class="text-white text-decoration-none"
                               href="?month={{ year }}-{{ month_num|stringformat:'02d' }}&date={{ year }}-{{ month_num|stringformat:'02d' }}-{{ day|stringformat:'02d' }}">
                              {{ day }}
                            </a>
                            {% if count and count > 0 %}<div class="small">{{ count }}</div>{% endif %}
                          </td>
                        {% else %}
                          {% if count and count > 0 %}
                            <td class="p-1 text-center" style="cursor:pointer;background:#e9f7ef;">
                              <a class="text-decoration-none"
                                 href="?month={{ year }}-{{ month_num|stringformat:'02d' }}&date={{ year }}-{{ month_num|stringformat:'02d' }}-{{ day|stringformat:'02d' }}">
                                {{ day }}
                              </a>
                              <div class="small text-success">{{ count }}</div>
                            </td>
                          {% else %}
                            <td class="p-1 text-center" style="cursor:default;background:#f8f9fa;">{{ day }}</td>
                          {% endif %}
                        {% endif %}
                      {% endwith %}
                    {% endif %}
                  {% endfor %}
                </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>

      <!-- Слоты выбранного дня — под календарём -->
      <div class="card">
        <div class="card-body p-3">
          {% if selected_date %}
            <div class="d-flex justify-content-between align-items-center mb-2">
              <strong>Слоты на {{ selected_date|date:"d.m.Y" }}</strong>
              <small class="text-muted">{{ availabilities_day|length }} шт.</small>
            </div>

            {% if availabilities_day %}
              <ul class="list-group" id="day-slots-list">
                {% for a in availabilities_day %}
                  <li class="list-group-item d-flex justify-content-between align-items-center">
                    <div>
                      <strong>{{ a.start_time|format_time }} — {{ a.end_time|format_time }}</strong>
                      {% if a.service %}
                        <div class="small text-muted mt-1">
                          {% if a.service.activity_area %}{{ a.service.activity_area.get_category_display }}: {% endif %}
                          {{ a.service.service_name }}
                        </div>
                      {% endif %}
                    </div>

                    <div class="d-flex gap-2">
                      <a href="#"
                         class="btn btn-sm btn-outline-primary edit-slot-btn"
                         data-avail-id="{{ a.pk }}">
                        Редактировать
                      </a>

                      <button type="button"
                              class="btn btn-sm btn-outline-danger delete-slot-btn"
                              data-avail-id="{{ a.pk }}">
                        Удалить
                      </button>
                    </div>
                  </li>
                {% endfor %}
              </ul>
            {% else %}
              <div class="alert alert-info mb-0">Нет слотов на эту дату.</div>
            {% endif %}
          {% else %}
            <div class="text-muted">Нажмите на день в календаре, чтобы увидеть слоты и редактировать их.</div>
          {% endif %}
        </div>
      </div>
    </div>

    <!-- Правая колонка: форма formset -->
    <div class="col-md-8">
      <form method="post" novalidate id="formset-main">
        {% csrf_token %}
        {{ formset.management_form }}

        <div class="mb-3">
          {% for form in formset.forms %}
            {# Оборачиваем каждую форму в card с id, чтобы JS мог найти нужную форму по availability.pk #}
            {% if form.instance and form.instance.pk %}
              <div class="card mb-2 p-3" id="avail-form-{{ form.instance.pk }}" data-avail-id="{{ form.instance.pk }}">
            {% else %}
              <div class="card mb-2 p-3" id="avail-form-new-{{ forloop.counter }}" data-avail-id="">
            {% endif %}
              {{ form.id }}
              <div class="row g-2">
                <div class="col-md-3">
                  <label class="form-label">{{ form.date.label }}</label>
                  {{ form.date }}
                  {% if form.date.errors %}<div class="text-danger small">{{ form.date.errors|join:", " }}</div>{% endif %}
                </div>

                <div class="col-md-2">
                  <label class="form-label">{{ form.start_time.label }}</label>
                  {{ form.start_time }}
                  {% if form.start_time.errors %}<div class="text-danger small">{{ form.start_time.errors|join:", " }}</div>{% endif %}
                </div>

                <div class="col-md-2">
                  <label class="form-label">{{ form.end_time.label }}</label>
                  {{ form.end_time }}
                  {% if form.end_time.errors %}<div class="text-danger small">{{ form.end_time.errors|join:", " }}</div>{% endif %}
                </div>

                <div class="col-md-3">
                  <label class="form-label">{{ form.service.label }}</label>
                  {{ form.service }}
                  {% if form.service.errors %}<div class="text-danger small">{{ form.service.errors|join:", " }}</div>{% endif %}
                </div>

                <div class="col-md-2 d-flex align-items-center">
                  {% if form.DELETE %}
                    <div class="form-check">
                      {{ form.DELETE }} <label class="form-check-label ms-1">Удалить</label>
                    </div>
                  {% endif %}
                </div>
              </div>

              {% if form.non_field_errors %}
                <div class="text-danger small mt-2">{{ form.non_field_errors|join:", " }}</div>
              {% endif %}
            </div>
          {% endfor %}
        </div>

        <button class="btn btn-primary" type="submit">Сохранить изменения</button>
      </form>
    </div>
  </div>

  <!-- Текущее расписание (за месяц) -->
  <h3 class="mt-4">Текущее расписание (за месяц)</h3>
  <ul class="list-group mb-4">
    {% for a in availabilities %}
      <li class="list-group-item d-flex justify-content-between align-items-center">
        <div>
          <strong>{{ a.date|date:"d.m.Y" }}</strong>
          — <span>{{ a.start_time|format_time }} - {{ a.end_time|format_time }}</span>
          {% if a.service %}
            <div class="small text-muted">
              {% if a.service.activity_area %}{{ a.service.activity_area.get_category_display }}: {% endif %}
              {{ a.service.service_name }}
            </div>
          {% endif %}
        </div>
        <div class="small text-muted">{{ a.created_at|date:"d.m.Y H:i" }}</div>
      </li>
    {% empty %}
      <li class="list-group-item">Расписание пусто.</li>
    {% endfor %}
  </ul>
</div>

<style>
  .highlight { box-shadow: 0 0 0 3px rgba(66,133,244,0.18); transition: box-shadow 0.25s ease-in-out; }
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
  // Кнопка "Редактировать" — скроллит к форме
  document.querySelectorAll('.edit-slot-btn').forEach(function(btn){
    btn.addEventListener('click', function(e){
      e.preventDefault();
      var id = btn.dataset.availId;
      if (!id) return;
      var formCard = document.getElementById('avail-form-' + id);
      if (!formCard) {
        alert('Форма не найдена. Обновите страницу.');
        return;
      }
      formCard.scrollIntoView({behavior: 'smooth', block: 'center'});
      formCard.classList.add('highlight');
      setTimeout(function(){ formCard.classList.remove('highlight'); }, 2000);
    });
  });

  // Кнопка "Удалить" — отмечает checkbox DELETE в соответствующей форме и отправляет formset
  document.querySelectorAll('.delete-slot-btn').forEach(function(btn){
    btn.addEventListener('click', function(){
      var id = btn.dataset.availId;
      if (!id) return;
      if (!confirm('Удалить этот слот? Это действие можно отменить только вручную.')) return;

      var card = document.getElementById('avail-form-' + id);
      if (!card) {
        alert('Форма для этого слота не найдена в formset. Обновите страницу.');
        return;
      }

      // ищем checkbox DELETE внутри этой формы (имя оканчивается на "-DELETE")
      var deleteCheckbox = card.querySelector('input[type="checkbox"][name$="-DELETE"]');
      if (deleteCheckbox) {
        deleteCheckbox.checked = true;
        // отправляем formset
        document.getElementById('formset-main').submit();
        return;
      }

      // Если чекбокса нет (на случай, если форма рендерится без can_delete) — попробуем создать hidden input:
      var prefixInput = Array.from(card.querySelectorAll('input[type="hidden"]')).find(function(i){
        return /-id$/.test(i.name) || /-pk$/.test(i.name) || /-instance/;
      });
      // попробуем найти префикс, чтобы добавить поле DELETE: берём management form TOTAL_FORMS чтобы пробежать имена
      var managementPrefix = null;
      // fallback: создаём простое hidden name "unknown-DELETE" (скорее всего не сработает), поэтому уведомим
      alert('Чекбокс для удаления не найден. Проверьте, что formset создан с can_delete=True.');
    });
  });
});
</script>
{% endblock %}
