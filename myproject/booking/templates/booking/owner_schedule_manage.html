{% extends "base.html" %}
{% load dict_extras time_extras %}

{% block title %}Расписание — {{ specialist.first_name }}{% endblock %}

{% block content %}
<div class="container my-4">
  <h2>Расписание для {{ specialist.first_name }} {{ specialist.last_name }}</h2>

  <p class="small text-muted">
    Услуги ниже показывают только те позиции, которые назначены этому специалисту.
  </p>

  {% if specialist.services.exists %}
    <div class="mb-3">
      <strong>Услуги специалиста:</strong>
      {% for s in specialist.services.all %}
        <span class="badge bg-secondary me-1">{{ s.service_name }}</span>
      {% endfor %}
    </div>
  {% else %}
    <div class="alert alert-warning">У специалиста ещё не назначены услуги. Назначьте услуги на странице управления специалистом.</div>
  {% endif %}

  <div class="row mb-4">
    <div class="col-md-4">
      <form method="get" class="d-flex gap-2 align-items-center">
        <label class="mb-0">Месяц</label>
        <input type="month" name="month" value="{{ month }}" class="form-control w-auto">
        <button class="btn btn-secondary" type="submit">Показать</button>
      </form>

      <!-- Компактный календарик -->
      <div class="card mt-3">
        <div class="card-body p-3">
          <div class="d-flex justify-content-between align-items-center mb-2">
            <strong>{{ month_name }} {{ year }}</strong>
            <small class="text-muted">Кликните на день</small>
          </div>

          <table class="table table-bordered mb-0 calendar-table small">
            <thead>
              <tr>
                {% for wd in weekdays %}
                  <th class="text-center p-1">{{ wd }}</th>
                {% endfor %}
              </tr>
            </thead>
            <tbody>
              {% for week in month_days_matrix %}
                <tr>
                  {% for day in week %}
                    {% if day == 0 %}
                      <td class="p-2" style="height:40px;background:#f8f9fa;"></td>
                    {% else %}
                      {% with count=day_counts|get_item:day %}
                        {% if selected_date and selected_date.day == day and selected_date.month == month_num and selected_date.year == year %}
                          <td class="p-1 text-center bg-primary text-white" style="cursor:pointer;">
                            <a class="text-white text-decoration-none" href="?month={{ year }}-{{ month_num|stringformat:'02d' }}&date={{ year }}-{{ month_num|stringformat:'02d' }}-{{ day|stringformat:'02d' }}">
                              {{ day }}
                            </a>
                            {% if count and count > 0 %}<div class="small">{{ count }}</div>{% endif %}
                          </td>
                        {% else %}
                          {% if count and count > 0 %}
                            <td class="p-1 text-center" style="cursor:pointer;background:#e9f7ef;">
                              <a class="text-decoration-none" href="?month={{ year }}-{{ month_num|stringformat:'02d' }}&date={{ year }}-{{ month_num|stringformat:'02d' }}-{{ day|stringformat:'02d' }}">
                                {{ day }}
                              </a>
                              <div class="small text-success">{{ count }}</div>
                            </td>
                          {% else %}
                            <td class="p-1 text-center" style="cursor:default;background:#f8f9fa;">{{ day }}</td>
                          {% endif %}
                        {% endif %}
                      {% endwith %}
                    {% endif %}
                  {% endfor %}
                </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>
    </div>

    <div class="col-md-8">
      <!-- Форма редактирования/добавления таймслотов -->
      <form method="post" novalidate>
        {% csrf_token %}
        {{ formset.management_form }}

        <div class="mb-3">
          {% for form in formset.forms %}
            <div class="card mb-2 p-3">
              {{ form.id }}
              <div class="row g-2">
                <div class="col-md-3">
                  <label class="form-label">{{ form.date.label }}</label>
                  {{ form.date }}
                  {% if form.date.errors %}<div class="text-danger small">{{ form.date.errors|join:", " }}</div>{% endif %}
                </div>

                <div class="col-md-2">
                  <label class="form-label">{{ form.start_time.label }}</label>
                  {{ form.start_time }}
                  {% if form.start_time.errors %}<div class="text-danger small">{{ form.start_time.errors|join:", " }}</div>{% endif %}
                </div>

                <div class="col-md-2">
                  <label class="form-label">{{ form.end_time.label }}</label>
                  {{ form.end_time }}
                  {% if form.end_time.errors %}<div class="text-danger small">{{ form.end_time.errors|join:", " }}</div>{% endif %}
                </div>

                <div class="col-md-3">
                  <label class="form-label">{{ form.service.label }}</label>
                  {{ form.service }}
                  {% if form.service.errors %}<div class="text-danger small">{{ form.service.errors|join:", " }}</div>{% endif %}
                </div>

                <div class="col-md-2 d-flex align-items-center">
                  {% if form.DELETE %}
                    <div class="form-check">
                      {{ form.DELETE }} <label class="form-check-label ms-1">Удалить</label>
                    </div>
                  {% endif %}
                </div>
              </div>

              {% if form.non_field_errors %}
                <div class="text-danger small mt-2">{{ form.non_field_errors|join:", " }}</div>
              {% endif %}
            </div>
          {% endfor %}
        </div>

        <button class="btn btn-primary" type="submit">Сохранить изменения</button>
      </form>
    </div>
  </div>

  <!-- Текущее расписание (за месяц) -->
  <h3 class="mt-4">Текущее расписание (за месяц)</h3>
  <ul class="list-group mb-4">
    {% for a in availabilities %}
      <li class="list-group-item d-flex justify-content-between align-items-center">
        <div>
          <strong>{{ a.date|date:"d.m.Y" }}</strong>
          — <span>{{ a.start_time|format_time }} - {{ a.end_time|format_time }}</span>
          {% if a.service %}
            <div class="small text-muted">
              {% if a.service.activity_area %}{{ a.service.activity_area.get_category_display }}: {% endif %}
              {{ a.service.service_name }}
            </div>
          {% endif %}
        </div>
        <div class="small text-muted">{{ a.created_at|date:"d.m.Y H:i" }}</div>
      </li>
    {% empty %}
      <li class="list-group-item">Расписание пусто.</li>
    {% endfor %}
  </ul>

  <!-- Если выбран день — покажем слоты на этот день -->
  {% if selected_date %}
    <h3>Слоты на {{ selected_date|date:"d.m.Y" }}</h3>
    <ul class="list-group mb-4">
      {% for a in availabilities_day %}
        <li class="list-group-item">
          <strong>{{ a.start_time|format_time }} - {{ a.end_time|format_time }}</strong>
          {% if a.service %}
            <span class="ms-2 text-muted">— {{ a.service.service_name }}</span>
          {% endif %}
        </li>
      {% empty %}
        <li class="list-group-item">Нет слотов на эту дату.</li>
      {% endfor %}
    </ul>
  {% endif %}
</div>
{% endblock %}
