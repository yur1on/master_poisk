{% extends "base.html" %}
{% load static crispy_forms_tags format_duration %}

{% block content %}
<style>
  :root {
    --primary-color: #00897b;
    --secondary-color: #ff8a65;
    --accent-color: #ba68c8;
    --bg-light: #f5f7fa;
    --text-dark: #1a202c;
    --sidebar-bg: #2d3748;
    --shadow-sm: 0 2px 8px rgba(0, 0, 0, 0.1);
    --shadow-md: 0 4px 16px rgba(0, 0, 0, 0.15);
    --transition: all 0.3s ease;
  }

  /* Reset and base styles */
  * {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
    font-family: 'Roboto', sans-serif;
  }

  body {
    background: var(--bg-light);
    color: var(--text-dark);
  }

  /* Dashboard container */
  .dashboard-container {
    display: flex;
    min-height: 100vh;
    overflow-x: hidden;
  }

  /* Sidebar */
  .sidebar {
    position: fixed;
    top: 0;
    left: 0;
    width: 240px;
    height: 100%;
    background: var(--sidebar-bg);
    padding: 20px;
    display: flex;
    flex-direction: column;
    gap: 12px;
    transition: var(--transition);
    z-index: 1000;
  }

  .sidebar a {
    display: flex;
    align-items: center;
    padding: 12px 16px;
    border-radius: 8px;
    font-size: 15px;
    font-weight: 500;
    text-decoration: none;
    color: white;
    transition: var(--transition);
    gap: 10px;
  }

  .sidebar a i {
    font-size: 18px;
  }

  .sidebar a.profile-btn {
    background: var(--primary-color);
  }

  .sidebar a.profile-btn:hover,
  .sidebar a.profile-btn.active {
    background: #00695c;
    transform: translateX(5px);
  }

  .sidebar a.prices-btn {
    background: var(--secondary-color);
  }

  .sidebar a.prices-btn:hover,
  .sidebar a.prices-btn.active {
    background: #f4511e;
    transform: translateX(5px);
  }

  .sidebar a.showcase-btn {
    background: var(--accent-color);
  }

  .sidebar a.showcase-btn:hover,
  .sidebar a.showcase-btn.active {
    background: #8e24aa;
    transform: translateX(5px);
  }

  /* Content container */
  .profile-container {
    flex: 1;
    margin-left: 240px;
    padding: 30px;
    width: calc(100% - 240px);
  }

  .profile-container h2 {
    font-size: 2rem;
    font-weight: 700;
    margin-bottom: 2rem;
    color: var(--text-dark);
    text-align: center;
  }

  /* Card styles */
  .card {
    border: none;
    border-radius: 12px;
    background: white;
    box-shadow: var(--shadow-sm);
    transition: var(--transition);
    margin-bottom: 20px;
    width: 100%;
  }

  .card:hover {
    transform: translateY(-5px);
    box-shadow: var(--shadow-md);
  }

  .card-header {
    background: var(--primary-color);
    color: white;
    font-weight: 600;
    border-radius: 12px 12px 0 0;
    padding: 15px 20px;
  }

  .card-body {
    padding: 20px;
  }

  /* Activity list */
  .activity-list {
    list-style: none;
    padding: 0;
  }

  .activity-list li {
    padding: 8px 0;
    display: flex;
    align-items: center;
    font-size: 0.95rem;
  }

  .activity-list li::before {
    content: "\f00c";
    font-family: "Font Awesome 5 Free";
    font-weight: 900;
    color: var(--primary-color);
    margin-right: 10px;
  }

  /* Content sections */
  .content-section {
    display: none;
    width: 100%;
  }

  .content-section.active {
    display: block;
    animation: fadeIn 0.3s ease-in;
  }

  @keyframes fadeIn {
    from { opacity: 0; transform: translateY(10px); }
    to { opacity: 1; transform: translateY(0); }
  }

  /* Forms */
  .beauty-form {
    background: white;
    padding: 25px;
    border-radius: 12px;
    box-shadow: var(--shadow-sm);
    width: 100%;
  }

  .btn-primary {
    background: var(--primary-color);
    border: none;
    border-radius: 8px;
    padding: 12px 24px;
    font-weight: 500;
    transition: var(--transition);
  }

  .btn-primary:hover {
    background: #00695c;
    transform: scale(1.05);
  }

  .alert-success, .alert-danger {
    margin-top: 15px;
    padding: 10px;
    border-radius: 6px;
  }

  .alert-success {
    background: #c8e6c9;
    color: #2e7d32;
  }

  .alert-danger {
    background: #ffcdd2;
    color: #d32f2f;
  }

  .errorlist,
  .error-message {
    color: #e53e3e;
    font-size: 0.9rem;
    margin-bottom: 15px;
  }

  /* Service form */
  .service-form {
    background: #f7fafc;
    padding: 15px;
    border-radius: 8px;
    border-left: 4px solid var(--primary-color);
    margin-bottom: 15px;
    transition: var(--transition);
    width: 100%;
  }

  .service-form:hover {
    box-shadow: var(--shadow-sm);
  }

  .remove-btn {
    background: #fed7d7;
    color: #9b2c2c;
    border: none;
    border-radius: 6px;
    padding: 8px 16px;
    font-size: 0.9rem;
    transition: var(--transition);
  }

  .remove-btn:hover {
    background: #feb2b2;
  }

  .add-btn {
    background: var(--primary-color);
    color: white;
    border-radius: 50%;
    width: 48px;
    height: 48px;
    display: flex;
    align-items: center;
    justify-content: center;
    margin: 20px auto;
    font-size: 1.5rem;
    transition: var(--transition);
  }

  .add-btn:hover {
    background: #00695c;
    transform: scale(1.1);
  }

  /* Custom checkbox */
  .custom-checkbox .custom-control-input {
    display: none;
  }

  .custom-checkbox .custom-control-label::before {
    content: '';
    display: inline-block;
    width: 20px;
    height: 20px;
    border: 2px solid var(--primary-color);
    border-radius: 4px;
    margin-right: 12px;
    background: white;
    transition: var(--transition);
  }

  .custom-checkbox .custom-control-input:checked + .custom-control-label::before {
    background: var(--primary-color);
    border-color: var(--primary-color);
  }

  .custom-checkbox .custom-control-input:checked + .custom-control-label::after {
    content: '\2713';
    position: absolute;
    left: 7px;
    top: 3px;
    color: white;
    font-size: 14px;
    font-weight: bold;
  }

  /* Showcase form */
  .upload-form {
    background: white;
    padding: 20px;
    border-radius: 12px;
    box-shadow: var(--shadow-sm);
    width: 100%;
  }

  .upload-form label {
    font-weight: 500;
    color: var(--text-dark);
  }

  .upload-form input[type="file"],
  .upload-form textarea {
    border: 1px solid #e2e8f0;
    border-radius: 6px;
    padding: 10px;
    width: 100%;
  }

  .upload-form textarea {
    resize: vertical;
    min-height: 100px;
  }

  /* Price table */
  .price-table {
    width: 100%;
    border-collapse: separate;
    border-spacing: 0;
    background: white;
    border-radius: 12px;
    overflow: hidden;
    box-shadow: var(--shadow-sm);
    margin-bottom: 20px;
  }

  .price-table th,
  .price-table td {
    padding: 16px;
    text-align: left;
    border-bottom: 1px solid #e2e8f0;
  }

  .price-table th {
    background: var(--primary-color);
    color: white;
    font-weight: 600;
    font-size: 1rem;
  }

  .price-table td {
    font-size: 0.95rem;
    color: var(--text-dark);
  }

  .price-table .price-cell {
    text-align: right;
    color: var(--secondary-color);
    font-weight: 600;
  }

  .price-table tr {
    transition: var(--transition);
  }

  .price-table tr:hover {
    background: #f7fafc;
    transform: scale(1.01);
    box-shadow: var(--shadow-md);
  }

  /* Mobile price cards */
  .price-mobile {
    display: none;
  }

  .price-card {
    background: white;
    border-radius: 12px;
    box-shadow: var(--shadow-sm);
    padding: 16px;
    margin-bottom: 16px;
    transition: var(--transition);
  }

  .price-card:hover {
    transform: translateY(-3px);
    box-shadow: var(--shadow-md);
  }

  .price-card div {
    display: flex;
    justify-content: space-between;
    margin-bottom: 8px;
    font-size: 0.9rem;
  }

  .price-card div:last-child {
    margin-bottom: 0;
  }

  .price-card .label {
    font-weight: 500;
    color: var(--text-dark);
  }

  .price-card .value {
    color: var(--text-dark);
  }

  .price-card .price-value {
    color: var(--secondary-color);
    font-weight: 600;
  }

  /* Social links */
  .social-links p { margin-bottom: 8px; }
  .social-links a { text-decoration: none; color: var(--primary-color); font-weight: 500; }

  /* Responsive design */
  @media (max-width: 768px) {
    .sidebar {
      width: 80px;
      padding: 10px;
    }

    .sidebar a {
      font-size: 0;
      justify-content: center;
    }

    .sidebar a i {
      font-size: 20px;
    }

    .profile-container {
      margin-left: 80px;
      width: calc(100% - 80px);
      padding: 20px;
    }

    .price-table th,
    .price-table td {
      padding: 12px;
      font-size: 0.9rem;
    }

    .price-table th {
      font-size: 0.95rem;
    }
  }

  @media (max-width: 576px) {
    .sidebar {
      width: 100%;
      height: auto;
      flex-direction: row;
      justify-content: center;
      padding: 10px;
      position: sticky;
      top: 0;
    }

    .profile-container {
      margin-left: 0;
      width: 100%;
      margin-top: 80px;
      padding: 15px;
    }

    .service-form .col-md-3,
    .service-form .col-md-2 {
      flex: 0 0 100%;
      max-width: 100%;
    }

    .price-table {
      display: none;
    }

    .price-table + .price-mobile {
      display: block;
    }
  }
</style>

<div class="dashboard-container">
  <!-- Sidebar -->
  <div class="sidebar">
    <a href="#" class="profile-btn active" data-section="profile-details"><i class="fas fa-user"></i> Профиль</a>
    <a href="#" class="profile-btn" data-section="edit-profile"><i class="fas fa-edit"></i> Редактировать профиль</a>
    {% if is_workshop %}
      <a href="#" class="prices-btn" data-section="edit-prices"><i class="fas fa-dollar-sign"></i> Редактировать цены</a>
      <a href="#" class="showcase-btn" data-section="edit-showcase"><i class="fas fa-store"></i> Редактировать витрину</a>
    {% endif %}
    {% if is_workshop %}

    <button onclick="window.location.href='{% url 'booking:owner_specialists_list' %}'">Специалисты</button>
    {% endif %}
  </div>

  <!-- Content -->
  <div class="profile-container">

    <!-- Profile Section -->
    <div id="profile-details" class="content-section active">
      {% if is_client %}
        <div class="card">
          <div class="card-header">
            <h4>Профиль клиента</h4>
          </div>
          <div class="card-body">
            <p class="profile-name"><strong>Имя:</strong> {{ client_profile.name|default:user.username }}</p>
            <p class="profile-email"><strong>Email:</strong> {{ user.email }}</p>
            <p class="profile-phone"><strong>Телефон:</strong> {{ client_profile.phone }}</p>
            <p class="profile-city"><strong>Город:</strong> {{ client_profile.city|default:"Не указано" }}</p>
            {% if is_client %}
<a href="{% url 'booking:client_my_appointments' %}">Мои записи</a>
{% endif %}
          </div>
        </div>
      {% elif is_workshop %}
        <div class="card">
          <div class="card-header">
            <h4>Профиль бьюти-студии</h4>
          </div>
          <div class="card-body">
            <p class="profile-workshop-name"><strong>Название бьюти-студии:</strong> {{ workshop_profile.workshop_name }}</p>
            <p class="profile-workshop-address"><strong>Адрес:</strong> {{ workshop_profile.workshop_address }}</p>
            <p class="profile-city"><strong>Город:</strong> {{ workshop_profile.city|default:"Не указано" }}</p>
            <p class="profile-email"><strong>Email:</strong> {{ user.email }}</p>
            <p class="profile-phone"><strong>Телефон:</strong> {{ workshop_profile.phone }}</p>
            <p class="profile-description"><strong>Описание:</strong> {{ workshop_profile.description|default:"Не указано" }}</p>
            <p class="profile-working-hours"><strong>Время работы:</strong> {{ workshop_profile.working_hours|default:"Не указано" }}</p>

            <!-- Социальные контакты (если есть showcase) -->
            {% if workshop_profile.showcase %}
              <div class="social-links mt-3">
                {% if workshop_profile.showcase.telegram %}
                  <p class="telegram">
                    <strong>Telegram:</strong>
                    {% if workshop_profile.showcase.telegram|slice:":4" == "http" %}
                      <a href="{{ workshop_profile.showcase.telegram }}" target="_blank" rel="noopener">{{ workshop_profile.showcase.telegram }}</a>
                    {% else %}
                      <a href="https://t.me/{{ workshop_profile.showcase.telegram|urlencode }}" target="_blank" rel="noopener">{{ workshop_profile.showcase.telegram }}</a>
                    {% endif %}
                  </p>
                {% endif %}
                {% if workshop_profile.showcase.instagram %}
                  <p class="instagram">
                    <strong>Instagram:</strong>
                    {% if workshop_profile.showcase.instagram|slice:":4" == "http" %}
                      <a href="{{ workshop_profile.showcase.instagram }}" target="_blank" rel="noopener">{{ workshop_profile.showcase.instagram }}</a>
                    {% else %}
                      <a href="https://instagram.com/{{ workshop_profile.showcase.instagram|urlencode }}" target="_blank" rel="noopener">{{ workshop_profile.showcase.instagram }}</a>
                    {% endif %}
                  </p>
                {% endif %}
                {% if workshop_profile.showcase.viber %}
                  <p class="viber">
                    <strong>Viber:</strong>
                    {% if workshop_profile.showcase.viber|slice:":6" == "viber:" or workshop_profile.showcase.viber|slice:":4" == "http" %}
                      <a href="{{ workshop_profile.showcase.viber }}" target="_blank" rel="noopener">{{ workshop_profile.showcase.viber }}</a>
                    {% else %}
                      {{ workshop_profile.showcase.viber }}
                    {% endif %}
                  </p>
                {% endif %}
              </div>
            {% endif %}

            <p><strong>Сферы деятельности:</strong></p>
            {% if grouped_activities %}
              {% for category, activities in grouped_activities.items %}
                <h5>{{ category }}</h5>
                <ul class="activity-list">
                  {% for activity in activities %}
                    <li>{{ activity.name }}</li>
                  {% endfor %}
                </ul>
              {% endfor %}
            {% else %}
              <p>Не указано</p>
            {% endif %}

            <h4>Услуги и цены</h4>
            {% if workshop_profile.service_prices.exists %}
              {% for category, prices in grouped_prices.items %}
                <h5>{{ category }}</h5>
                <table class="price-table">
                  <thead>
                    <tr>
                      <th>Услуга</th>
                      <th>Цена (руб.)</th>
                      <th>Длительность</th>
                    </tr>
                  </thead>
                  <tbody>
                    {% for price in prices %}
                      <tr>
                        <td>{{ price.service_name }}</td>
                        <td class="price-cell">{{ price.price }}</td>
                        <td>{{ price.duration|format_duration|default:"Не указано" }}</td>
                      </tr>
                    {% endfor %}
                  </tbody>
                </table>
                <div class="price-mobile">
                  {% for price in prices %}
                    <div class="price-card">
                      <div>
                        <span class="label">Услуга:</span>
                        <span class="value">{{ price.service_name }}</span>
                      </div>
                      <div>
                        <span class="label">Цена:</span>
                        <span class="price-value">{{ price.price }} руб.</span>
                      </div>
                      <div>
                        <span class="label">Длительность:</span>
                        <span class="value">{{ price.duration|format_duration|default:"Не указано" }}</span>
                      </div>
                    </div>
                  {% endfor %}
                </div>
              {% endfor %}
            {% else %}
              <p>Цены на услуги не указаны.</p>
            {% endif %}
          </div>
        </div>
      {% else %}
        <p class="text-center">Профиль не найден.</p>
      {% endif %}
    </div>

    <!-- Edit Profile Section -->
    <div id="edit-profile" class="content-section">
      <div class="beauty-form">
        <h3 class="text-center mb-4">Редактировать профиль</h3>
        <div id="edit-profile-message" class="error-message"></div>
        {% if is_client %}
          <form id="edit-client-profile-form" method="post" action="{% url 'accounts:edit_profile' %}">
            {% csrf_token %}
            {{ client_form|crispy }}
            <button type="submit" class="btn btn-primary w-100 mt-3">Сохранить</button>
          </form>
        {% elif is_workshop %}
          <form id="edit-workshop-profile-form" method="post" action="{% url 'accounts:edit_profile' %}">
            {% csrf_token %}
            <fieldset class="mb-4">
              <legend>Детали профиля</legend>
              {{ workshop_form.workshop_name|as_crispy_field }}
              {{ workshop_form.workshop_address|as_crispy_field }}
              {{ workshop_form.city|as_crispy_field }}
              {{ workshop_form.email|as_crispy_field }}
            </fieldset>
            <fieldset class="mb-4">
              <legend>Сферы деятельности</legend>
              <div class="row">
                {% for category, areas in workshop_form.grouped_activity.items %}
                  <div class="col-md-4 mb-3">
                    <div class="card">
                      <div class="card-header">
                        <div class="form-check">
                          <input type="checkbox" id="select_all_{{ category }}" class.="select-all" data-category="{{ category }}">
                          <label for="select_all_{{ category }}">{{ category }} <small>(выбрать все)</small></label>
                        </div>
                      </div>
                      <div class="card-body">
                        {% for area in areas %}
                          <div class="form-check custom-checkbox">
                            <input
                              type="checkbox"
                              name="activity_area"
                              value="{{ area.pk }}"
                              id="area_{{ area.pk }}"
                              class="custom-control-input activity-area"
                              data-category="{{ category }}"
                              {% if area in workshop_form.initial.activity_area %}checked{% endif %}
                            />
                            <label for="area_{{ area.pk }}" class="custom-control-label">
                              {{ area.name }}
                            </label>
                          </div>
                        {% endfor %}
                      </div>
                    </div>
                  </div>
                {% endfor %}
              </div>
            </fieldset>
            <button type="submit" class="btn btn-primary w-100 mt-3">Сохранить</button>
          </form>
        {% endif %}
      </div>
    </div>

    <!-- Edit Prices Section -->
    {% if is_workshop %}
      <div id="edit-prices" class="content-section">
        <div class="beauty-form">
          <h3 class="text-center mb-4">Редактировать цены на услуги</h3>
          <div id="edit-prices-message" class="error-message"></div>
          {% if formset.errors or formset.non_form_errors %}
            <div class="alert alert-danger p-2">
              <ul class="errorlist">
                {% for error in formset.non_form_errors %}
                  <li>{{ error }}</li>
                {% endfor %}
                {% for form in formset %}
                  {% for field, errors in form.errors.items %}
                    <li>{{ field }}: {{ errors|join:", " }}</li>
                  {% endfor %}
                {% endfor %}
              </ul>
            </div>
          {% endif %}
          <form method="post" id="service-price-form" action="{% url 'accounts:edit_prices' %}">
            {% csrf_token %}
            {{ formset.management_form }}
            <div id="service-forms">
              {% for form in formset %}
                <div class="service-form row g-2 align-items-center" data-service-name="{{ form.instance.service_name|default:'' }}">
                  <div class="col-md-3">{{ form.activity_area|as_crispy_field }}</div>
                  <div class="col-md-3">{{ form.service_name|as_crispy_field }}</div>
                  <div class="col-md-2">{{ form.price|as_crispy_field }}</div>
                  <div class="col-md-2">{{ form.duration|as_crispy_field }}</div>
                  <div class="col-md-2 text-center">
                    <button type="button" class="remove-btn">Удалить</button>
                  </div>
                  {% if form.instance.pk %}
                    {{ form.id }}
                  {% endif %}
                  {{ form.DELETE }}
                </div>
              {% endfor %}
            </div>
            <button type="button" id="add-service-form" class="add-btn" title="Добавить услугу">+</button>
            <button type="submit" class="btn btn-primary w-100 mt-3">💾 Сохранить</button>
          </form>
        </div>
      </div>

      <!-- Edit Showcase Section -->
      <div id="edit-showcase" class="content-section">
        <div class="beauty-form">
          <h3 class="text-center mb-4">Редактировать витрину</h3>
          <div id="edit-showcase-message" class="error-message"></div>
          {% if showcase_form.errors or showcase_form.non_field_errors %}
            <div class="alert alert-danger">
              <ul class="errorlist">
                {% for error in showcase_form.non_field_errors %}
                  <li>{{ error }}</li>
                {% endfor %}
                {% for field, errors in showcase_form.errors.items %}
                  <li>{{ field }}: {{ errors|join:", " }}</li>
                {% endfor %}
              </ul>
            </div>
          {% endif %}
          <form method="post" id="edit-showcase-form" enctype="multipart/form-data" action="{% url 'showcase:edit_showcase' %}">
            {% csrf_token %}
            <fieldset class="mb-4">
              <legend>Обложка витрины</legend>
              {{ showcase_form.cover_photo|as_crispy_field }}
            </fieldset>

            <fieldset class="mb-4">
              <legend>Информация о студии</legend>
              {{ showcase_form.description|as_crispy_field }}
              {{ showcase_form.phone|as_crispy_field }}
              {{ showcase_form.working_hours|as_crispy_field }}

              <!-- Новые поля соцсетей -->
              <div class="row g-2">
                <div class="col-md-4">
                  {{ showcase_form.viber|as_crispy_field }}
                </div>
                <div class="col-md-4">
                  {{ showcase_form.telegram|as_crispy_field }}
                </div>
                <div class="col-md-4">
                  {{ showcase_form.instagram|as_crispy_field }}
                </div>
              </div>
            </fieldset>

            <button type="submit" class="btn btn-primary w-100 mt-3">Сохранить</button>
          </form>
        </div>
      </div>
    {% endif %}
  </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
  // Toggle content sections
  const buttons = document.querySelectorAll('.sidebar a');
  const sections = document.querySelectorAll('.content-section');

  buttons.forEach(button => {
    button.addEventListener('click', function(e) {
      e.preventDefault();
      const sectionId = this.dataset.section;

      buttons.forEach(btn => btn.classList.remove('active'));
      sections.forEach(section => section.classList.remove('active'));

      this.classList.add('active');
      document.getElementById(sectionId).classList.add('active');
    });
  });

  // Validate duration input
  function validateDurationInput(input) {
    const value = input.value.trim();
    const durationRegex = /^\d+\s*ч(\s*\d+\s*мин)?$|^\d+\s*мин$|^\d+(\.\d+)?$/;
    const errorElement = input.parentElement.querySelector('.error-message') || document.createElement('div');
    errorElement.className = 'error-message';
    if (!durationRegex.test(value) && value !== '') {
      errorElement.textContent = "Введите длительность в формате: 'X ч Y мин', 'X ч', 'Y мин' или число минут";
      input.parentElement.appendChild(errorElement);
      return false;
    } else {
      errorElement.textContent = '';
      return true;
    }
  }

  // Apply validation to existing duration fields
  document.querySelectorAll('input[name$="duration"]').forEach(input => {
    input.addEventListener('input', () => validateDurationInput(input));
  });

  // AJAX form submission
  function submitForm(formId, messageDivId, successCallback) {
    const form = document.getElementById(formId);
    const messageDiv = document.getElementById(messageDivId);

    if (!form || !messageDiv) {
      console.error(`Form (${formId}) or messageDiv (${messageDivId}) not found`);
      return;
    }

    form.addEventListener('submit', async function(e) {
      e.preventDefault();
      // Validate all duration fields
      const durationInputs = form.querySelectorAll('input[name$="duration"]');
      let isValid = true;
      durationInputs.forEach(input => {
        if (!validateDurationInput(input)) {
          isValid = false;
        }
      });
      if (!isValid) {
        messageDiv.innerHTML = '<div class="alert alert-danger">Пожалуйста, исправьте ошибки в поле длительности.</div>';
        return;
      }

      const formData = new FormData(form);

      try {
        const response = await fetch(form.action, {
          method: 'POST',
          body: formData,
          headers: {
            'X-CSRFToken': '{{ csrf_token }}',
            'X-Requested-With': 'XMLHttpRequest'
          }
        });

        const contentType = response.headers.get('content-type');
        if (!contentType || !contentType.includes('application/json')) {
          const text = await response.text();
          console.error('Expected JSON, received:', text.slice(0, 100));
          throw new Error('Server returned non-JSON response');
        }

        const data = await response.json();

        if (data.success) {
          messageDiv.innerHTML = '<div class="alert alert-success">Данные успешно сохранены!</div>';
          if (successCallback) {
            successCallback(data);
          }
          setTimeout(() => {
            messageDiv.innerHTML = '';
            location.reload(); // Полная перезагрузка страницы
          }, 1000);
        } else {
          let errorMsg = 'Произошла ошибка.';
          if (data.errors) {
            try {
              const errors = typeof data.errors === 'string' ? JSON.parse(data.errors) : data.errors;
              errorMsg = '<ul>';
              for (let field in errors) {
                errors[field].forEach(error => {
                  errorMsg += `<li>${field}: ${error.message || error}</li>`;
                });
              }
              errorMsg += '</ul>';
            } catch (e) {
              errorMsg = data.errors;
            }
          }
          messageDiv.innerHTML = `<div class="alert alert-danger">${errorMsg}</div>`;
        }
      } catch (error) {
        console.error('AJAX error:', error);
        messageDiv.innerHTML = `<div class="alert alert-danger">Произошла ошибка: ${error.message}</div>`;
      }
    });
  }

  // Edit Profile Form
  {% if is_client %}
    submitForm('edit-client-profile-form', 'edit-profile-message', function(data) {
      const fields = {
        '.profile-name': `<strong>Имя:</strong> ${data.name || '{{ user.username }}'}`,
        '.profile-email': `<strong>Email:</strong> ${data.email}`,
        '.profile-phone': `<strong>Телефон:</strong> ${data.phone}`,
        '.profile-city': `<strong>Город:</strong> ${data.city || 'Не указано'}`
      };
      Object.entries(fields).forEach(([selector, value]) => {
        const element = document.querySelector(`#profile-details .card-body ${selector}`);
        if (element) {
          element.innerHTML = value;
        } else {
          console.error(`Element not found: #profile-details .card-body ${selector}`);
        }
      });
    });
  {% elif is_workshop %}
    submitForm('edit-workshop-profile-form', 'edit-profile-message', function(data) {
      const fields = {
        '.profile-workshop-name': `<strong>Название бьюти-студии:</strong> ${data.workshop_name}`,
        '.profile-workshop-address': `<strong>Адрес:</strong> ${data.workshop_address}`,
        '.profile-city': `<strong>Город:</strong> ${data.city || 'Не указано'}`,
        '.profile-email': `<strong>Email:</strong> ${data.email}`,
        '.profile-phone': `<strong>Телефон:</strong> ${data.phone}`,
        '.profile-description': `<strong>Описание:</strong> ${data.description || 'Не указано'}`,
        '.profile-working-hours': `<strong>Время работы:</strong> ${data.working_hours || 'Не указано'}`
      };
      Object.entries(fields).forEach(([selector, value]) => {
        const element = document.querySelector(`#profile-details .card-body ${selector}`);
        if (element) {
          element.innerHTML = value;
        } else {
          console.error(`Element not found: #profile-details .card-body ${selector}`);
        }
      });
      const activitiesContainer = document.querySelector('#profile-details .card-body .activity-list')?.parentElement;
      if (activitiesContainer) {
        activitiesContainer.innerHTML = '<p><strong>Сферы деятельности:</strong></p>' + (data.activities_html || '<p>Не указано</p>');
      } else {
        console.error('Activities container not found');
      }
    });
  {% endif %}

  {% if is_workshop %}
    // Edit Prices Form
    submitForm('service-price-form', 'edit-prices-message', function(data) {
      const pricesContainer = document.querySelector('#profile-details .card-body .price-table')?.parentElement;
      if (pricesContainer) {
        pricesContainer.innerHTML = '<h4>Услуги и цены</h4>' + (data.prices_html || '<p>Цены на услуги не указаны.</p>');
      } else {
        console.error('Prices container not found');
      }
    });

    // Edit Showcase Form
    submitForm('edit-showcase-form', 'edit-showcase-message', function(data) {
      const fields = {
        '.profile-description': `<strong>Описание:</strong> ${data.description || 'Не указано'}`,
        '.profile-phone': `<strong>Телефон:</strong> ${data.phone || 'Не указано'}`,
        '.profile-working-hours': `<strong>Время работы:</strong> ${data.working_hours || 'Не указано'}`
      };
      Object.entries(fields).forEach(([selector, value]) => {
        const element = document.querySelector(`#profile-details .card-body ${selector}`);
        if (element) {
          element.innerHTML = value;
        } else {
          console.error(`Element not found: #profile-details .card-body ${selector}`);
        }
      });

      // Обновление соцсетей (корректно подставляем href, если данные — полная ссылка)
      function ensureSocialContainer() {
        let container = document.querySelector('#profile-details .card-body .social-links');
        if (!container) {
          container = document.createElement('div');
          container.className = 'social-links mt-3';
          document.querySelector('#profile-details .card-body').appendChild(container);
        }
        return container;
      }

      const socialContainer = ensureSocialContainer();

      // Telegram
      if (data.telegram !== undefined) {
        let tg = socialContainer.querySelector('.telegram');
        if (!tg) {
          tg = document.createElement('p');
          tg.className = 'telegram';
          socialContainer.appendChild(tg);
        }
        if (data.telegram) {
          const isLink = data.telegram.slice(0,4) === 'http';
          const tgHref = isLink ? data.telegram : `https://t.me/${encodeURIComponent(data.telegram)}`;
          tg.innerHTML = `<strong>Telegram:</strong> <a href="${tgHref}" target="_blank" rel="noopener">${data.telegram}</a>`;
        } else {
          tg.innerHTML = `<strong>Telegram:</strong> Не указано`;
        }
      }

      // Instagram
      if (data.instagram !== undefined) {
        let ig = socialContainer.querySelector('.instagram');
        if (!ig) {
          ig = document.createElement('p');
          ig.className = 'instagram';
          socialContainer.appendChild(ig);
        }
        if (data.instagram) {
          const isLink = data.instagram.slice(0,4) === 'http';
          const igHref = isLink ? data.instagram : `https://instagram.com/${encodeURIComponent(data.instagram)}`;
          ig.innerHTML = `<strong>Instagram:</strong> <a href="${igHref}" target="_blank" rel="noopener">${data.instagram}</a>`;
        } else {
          ig.innerHTML = `<strong>Instagram:</strong> Не указано`;
        }
      }

      // Viber
      if (data.viber !== undefined) {
        let vb = socialContainer.querySelector('.viber');
        if (!vb) {
          vb = document.createElement('p');
          vb.className = 'viber';
          socialContainer.appendChild(vb);
        }
        if (data.viber) {
          const isViberLink = data.viber.slice(0,6) === 'viber:' || data.viber.slice(0,4) === 'http';
          if (isViberLink) {
            vb.innerHTML = `<strong>Viber:</strong> <a href="${data.viber}" target="_blank" rel="noopener">${data.viber}</a>`;
          } else {
            vb.innerHTML = `<strong>Viber:</strong> ${data.viber}`;
          }
        } else {
          vb.innerHTML = `<strong>Viber:</strong> Не указано`;
        }
      }
    });

    // Service Price Form JavaScript
    const serviceMap = {{ service_map|safe }};
    const activityCodes = {{ activity_codes|safe }};
    const formContainer = document.getElementById('service-forms');
    const addButton = document.getElementById('add-service-form');
    const totalForms = document.querySelector('#id_form-TOTAL_FORMS');
    const maxForms = {{ formset.max_num|default:100 }};
    let formNum = parseInt(totalForms.value);

    function updateServiceChoices(select, serviceSelect) {
      const code = activityCodes[select.value] || '';
      const services = serviceMap[code] || [];
      serviceSelect.innerHTML = '<option value="">---------</option>';
      services.forEach(service => {
        const option = document.createElement('option');
        option.value = service;
        option.text = service;
        serviceSelect.appendChild(option);
      });
      const formDiv = select.closest('.service-form');
      const selectedService = formDiv.dataset.serviceName || '';
      if (selectedService && services.includes(selectedService)) {
        serviceSelect.value = selectedService;
      } else {
        serviceSelect.value = '';
      }
    }

    function updateFormIndices() {
      const forms = Array.from(formContainer.querySelectorAll('.service-form'));
      forms.forEach((form, index) => {
        form.querySelectorAll('input, select, textarea').forEach(input => {
          if (input.name) {
            input.name = input.name.replace(/form-\d+-/, `form-${index}-`);
            input.id = input.id.replace(/id_form-\d+-/, `id_form-${index}-`);
          }
        });
      });
      totalForms.value = forms.length;
      formNum = parseInt(totalForms.value);
    }

    function removeForm(event) {
      const formDiv = event.target.closest('.service-form');
      const deleteInput = formDiv.querySelector('input[name$="-DELETE"]');
      if (deleteInput) {
        deleteInput.checked = true;
        formDiv.style.display = 'none';
      } else {
        formDiv.remove();
      }
      updateFormIndices();
    }

    function initializeForm(form) {
      const select = form.querySelector('select[name$="activity_area"]');
      const serviceSelect = form.querySelector('select[name$="service_name"]');
      const durationInput = form.querySelector('input[name$="duration"]');
      // Ensure DELETE field exists
      let deleteInput = form.querySelector('input[name$="-DELETE"]');
      if (!deleteInput) {
        deleteInput = document.createElement('input');
        deleteInput.type = 'checkbox';
        deleteInput.name = `form-${formNum}-DELETE`;
        deleteInput.id = `id_form-${formNum}-DELETE`;
        deleteInput.style.display = 'none';
        form.appendChild(deleteInput);
      }
      updateServiceChoices(select, serviceSelect);
      select.addEventListener('change', () => {
        updateServiceChoices(select, serviceSelect);
        form.dataset.serviceName = '';
      });
      durationInput.addEventListener('input', () => validateDurationInput(durationInput));
      const removeBtn = form.querySelector('.remove-btn');
      removeBtn.addEventListener('click', removeForm);
    }

    document.querySelectorAll('.service-form').forEach(initializeForm);

    addButton.addEventListener('click', function() {
      if (formNum >= maxForms) {
        alert('Максимальное количество услуг: ' + maxForms);
        return;
      }
      const templateForm = formContainer.querySelector('.service-form:last-child').cloneNode(true);
      templateForm.querySelector('input[name$="-DELETE"]')?.remove();
      templateForm.querySelector('input[name$="-id"]')?.remove();
      templateForm.querySelector('input[name$="price"]').value = '';
      templateForm.querySelector('input[name$="duration"]').value = '';
      templateForm.querySelector('select[name$="service_name"]').innerHTML = '<option value="">---------</option>';
      templateForm.dataset.serviceName = '';
      formContainer.appendChild(templateForm);
      updateFormIndices();
      initializeForm(templateForm);
    });

    // Edit Workshop Profile JavaScript
    document.querySelectorAll('.select-all').forEach(function(selectAll) {
      selectAll.addEventListener('change', function() {
        const category = this.dataset.category;
        const checkboxes = document.querySelectorAll('.activity-area[data-category="' + category + '"]');
        checkboxes.forEach(checkbox => {
          checkbox.checked = selectAll.checked;
        });
      });
    });
  {% endif %}
});
</script>

<link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
{% endblock %}
