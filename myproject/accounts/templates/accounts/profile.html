{% extends "base.html" %}
{% load static crispy_forms_tags %}

{% block content %}
<style>
  /* –û–±—â–∏–π –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä */
  .dashboard-container {
    display: flex;
    min-height: 100vh;
  }

  /* –°–∞–π–¥–±–∞—Ä */
  .sidebar {
    position: fixed;
    top: 0;
    left: 0;
    width: 180px;
    height: 100%;
    background: #2f3b52;
    padding: 15px 8px;
    box-shadow: 2px 0 10px rgba(0,0,0,0.08);
    display: flex;
    flex-direction: column;
    gap: 10px;
    z-index: 1000;
  }
  .sidebar a {
    display: block;
    padding: 8px 10px;
    text-align: center;
    border-radius: 6px;
    font-size: 14px;
    font-weight: 500;
    text-decoration: none;
    transition: background 0.2s, transform 0.2s;
    color: white;
    cursor: pointer;
  }
  .sidebar a.profile-btn {
    background: #4db6ac;
  }
  .sidebar a.profile-btn:hover, .sidebar a.profile-btn.active {
    background: #00897b;
    transform: scale(1.02);
  }
  .sidebar a.prices-btn {
    background: #ff8a65;
  }
  .sidebar a.prices-btn:hover, .sidebar a.prices-btn.active {
    background: #f4511e;
    transform: scale(1.02);
  }
  .sidebar a.showcase-btn {
    background: #ba68c8;
  }
  .sidebar a.showcase-btn:hover, .sidebar a.showcase-btn.active {
    background: #8e24aa;
    transform: scale(1.02);
  }

  /* –ö–æ–Ω—Ç–µ–Ω—Ç */
  .profile-container {
    flex: 1;
    margin-left: 200px;
    background: linear-gradient(135deg, #ffffff, #fff3e0);
    padding: 25px;
    border-radius: 12px;
    box-shadow: 0 6px 20px rgba(0,0,0,0.08);
    max-width: 900px;
    margin-top: 30px;
    margin-bottom: 30px;
  }
  .card {
    border: none;
    border-radius: 8px;
    background: #fff;
    transition: transform 0.3s ease, box-shadow 0.3s ease;
  }
  .card:hover {
    transform: translateY(-3px);
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
  }
  .card-header {
    background: #2e7d32;
    color: #fff;
    font-weight: 500;
    border-radius: 8px 8px 0 0;
    padding: 12px;
  }
  .activity-list {
    list-style: none;
    padding: 0;
  }
  .activity-list li::before {
    content: "\f00c";
    font-family: "Font Awesome 5 Free";
    font-weight: 900;
    color: #00897b;
    margin-right: 8px;
  }
  .content-section {
    display: none;
  }
  .content-section.active {
    display: block;
  }
  .beauty-form {
    background: #fff;
    padding: 20px;
    border-radius: 8px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.05);
  }
  .btn-primary {
    background: #00897b;
    border: none;
    border-radius: 8px;
    padding: 12px;
    transition: background 0.2s, transform 0.2s;
  }
  .btn-primary:hover {
    background: #00695c;
    transform: scale(1.03);
  }
  .errorlist, .error-message {
    color: #d32f2f;
    font-size: 0.9rem;
    margin-bottom: 15px;
  }
  /* –°—Ç–∏–ª–∏ –¥–ª—è edit_prices.html */
  .service-form {
    background: #f9f9f9;
    padding: 15px;
    border-radius: 8px;
    border-left: 5px solid #00897b;
    border: 1px solid #ddd;
    box-shadow: 0 2px 6px rgba(0, 0, 0, 0.04);
    margin-bottom: 15px;
    transition: box-shadow 0.2s ease, border-color 0.2s ease;
  }
  .service-form:hover {
    border-color: #bbb;
    box-shadow: 0 3px 10px rgba(0, 0, 0, 0.06);
  }
  .remove-btn {
    background-color: #f8d7da;
    color: #721c24;
    border: none;
    border-radius: 6px;
    padding: 6px 12px;
    font-size: 0.9rem;
    cursor: pointer;
    transition: all 0.2s ease;
  }
  .remove-btn:hover {
    background-color: #f5c6cb;
    color: #491217;
  }
  .add-btn {
    background-color: #00897b;
    color: white;
    font-size: 1.4rem;
    border: none;
    border-radius: 50%;
    width: 45px;
    height: 45px;
    display: flex;
    align-items: center;
    justify-content: center;
    margin: 15px auto;
    cursor: pointer;
    transition: background 0.2s ease;
  }
  .add-btn:hover {
    background-color: #00695c;
  }
  /* –°—Ç–∏–ª–∏ –¥–ª—è edit_workshop_profile.html */
  .custom-checkbox .custom-control-input {
    display: none;
  }
  .custom-checkbox .custom-control-label::before {
    content: '';
    display: inline-block;
    width: 18px;
    height: 18px;
    border: 2px solid #00897b;
    border-radius: 4px;
    margin-right: 10px;
    vertical-align: middle;
    background-color: #fff;
    transition: background-color 0.2s, border-color 0.2s;
  }
  .custom-checkbox .custom-control-input:checked + .custom-control-label::before {
    background-color: #00897b;
    border-color: #00897b;
  }
  .custom-checkbox .custom-control-input:checked + .custom-control-label::after {
    content: '\2713';
    display: inline-block;
    position: absolute;
    left: 6px;
    top: 2px;
    color: #fff;
    font-size: 12px;
    font-weight: bold;
  }
  .custom-checkbox .custom-control-label:hover::before {
    border-color: #00695c;
  }
  /* –°—Ç–∏–ª–∏ –¥–ª—è edit_showcase.html */
  .upload-form {
    background: linear-gradient(135deg, #ede7f6, #fce4ec);
    padding: 20px;
    border-radius: 8px;
    margin-bottom: 20px;
  }
  .upload-form label {
    font-weight: 500;
    color: #424242;
  }
  .upload-form input[type="file"], .upload-form textarea {
    border-radius: 6px;
    border: 1px solid #ce93d8;
    padding: 10px;
  }
  .upload-form textarea {
    resize: vertical;
    min-height: 80px;
  }
  /* –°—Ç–∏–ª–∏ –¥–ª—è –≥–∞–ª–µ—Ä–µ–∏ –≤ –ø—Ä–æ—Ñ–∏–ª–µ */
  .gallery-item img {
    width: 100%;
    height: 200px;
    object-fit: cover;
    border-radius: 8px;
    cursor: pointer;
  }
  .gallery-item p {
    margin: 10px 0;
    font-size: 0.9rem;
  }
</style>

<div class="dashboard-container">
  <!-- –°–∞–π–¥–±–∞—Ä -->
  <div class="sidebar">
    <a href="#" class="profile-btn active" data-section="profile-details">–ü—Ä–æ—Ñ–∏–ª—å</a>
    <a href="#" class="profile-btn" data-section="edit-profile">–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –ø—Ä–æ—Ñ–∏–ª—å</a>
    {% if is_workshop %}
      <a href="#" class="prices-btn" data-section="edit-prices">–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å —Ü–µ–Ω—ã</a>
      <a href="#" class="showcase-btn" data-section="edit-showcase">–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –≤–∏—Ç—Ä–∏–Ω—É</a>
    {% endif %}
  </div>

  <!-- –ö–æ–Ω—Ç–µ–Ω—Ç -->
  <div class="profile-container">
    <h2 class="text-center mb-4">–õ–∏—á–Ω—ã–π –∫–∞–±–∏–Ω–µ—Ç</h2>

    <!-- –°–µ–∫—Ü–∏—è: –ü—Ä–æ—Ñ–∏–ª—å -->
    <div id="profile-details" class="content-section active">
      {% if is_client %}
        <div class="card mb-4">
          <div class="card-header">
            <h4>–ü—Ä–æ—Ñ–∏–ª—å –∫–ª–∏–µ–Ω—Ç–∞</h4>
          </div>
          <div class="card-body">
            <p><strong>–ò–º—è:</strong> {{ client_profile.name|default:user.username }}</p>
            <p><strong>Email:</strong> {{ user.email }}</p>
            <p><strong>–¢–µ–ª–µ—Ñ–æ–Ω:</strong> {{ client_profile.phone }}</p>
            <p><strong>–ì–æ—Ä–æ–¥:</strong> {{ client_profile.city|default:"–ù–µ —É–∫–∞–∑–∞–Ω–æ" }}</p>
          </div>
        </div>
      {% elif is_workshop %}
        <div class="card mb-4">
          <div class="card-header">
            <h4>–ü—Ä–æ—Ñ–∏–ª—å –±—å—é—Ç–∏-—Å—Ç—É–¥–∏–∏</h4>
          </div>
          <div class="card-body">
            <p><strong>–ù–∞–∑–≤–∞–Ω–∏–µ –±—å—é—Ç–∏-—Å—Ç—É–¥–∏–∏:</strong> {{ workshop_profile.workshop_name }}</p>
            <p><strong>–ê–¥—Ä–µ—Å:</strong> {{ workshop_profile.workshop_address }}</p>
            <p><strong>–ì–æ—Ä–æ–¥:</strong> {{ workshop_profile.city|default:"–ù–µ —É–∫–∞–∑–∞–Ω–æ" }}</p>
            <p><strong>Email:</strong> {{ user.email }}</p>
            <p><strong>–¢–µ–ª–µ—Ñ–æ–Ω:</strong> {{ workshop_profile.phone }}</p>
            <p><strong>–û–ø–∏—Å–∞–Ω–∏–µ:</strong> {{ workshop_profile.description|default:"–ù–µ —É–∫–∞–∑–∞–Ω–æ" }}</p>
            <p><strong>–í—Ä–µ–º—è —Ä–∞–±–æ—Ç—ã:</strong> {{ workshop_profile.working_hours|default:"–ù–µ —É–∫–∞–∑–∞–Ω–æ" }}</p>
            <p><strong>–°—Ñ–µ—Ä—ã –¥–µ—è—Ç–µ–ª—å–Ω–æ—Å—Ç–∏:</strong></p>
            {% if grouped_activities %}
              {% for category, activities in grouped_activities.items %}
                <h5>{{ category }}</h5>
                <ul class="activity-list">
                  {% for activity in activities %}
                    <li>{{ activity.name }}</li>
                  {% endfor %}
                </ul>
              {% endfor %}
            {% else %}
              <p>–ù–µ —É–∫–∞–∑–∞–Ω–æ</p>
            {% endif %}
            <h4>–£—Å–ª—É–≥–∏ –∏ —Ü–µ–Ω—ã</h4>
            {% if workshop_profile.service_prices.exists %}
              {% for category, prices in grouped_prices.items %}
                <h5>{{ category }}</h5>
                <table class="table price-table">
                  <thead>
                    <tr>
                      <th>–£—Å–ª—É–≥–∞</th>
                      <th>–¶–µ–Ω–∞ (—Ä—É–±.)</th>
                      <th>–î–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å</th>
                    </tr>
                  </thead>
                  <tbody>
                    {% for price in prices %}
                      <tr>
                        <td>{{ price.service_name }}</td>
                        <td>{{ price.price }}</td>
                        <td>{{ price.duration|default:"–ù–µ —É–∫–∞–∑–∞–Ω–æ" }}</td>
                      </tr>
                    {% endfor %}
                  </tbody>
                </table>
              {% endfor %}
            {% else %}
              <p>–¶–µ–Ω—ã –Ω–∞ —É—Å–ª—É–≥–∏ –Ω–µ —É–∫–∞–∑–∞–Ω—ã.</p>
            {% endif %}
            {% if gallery %}
              <h4 class="mt-4">–ì–∞–ª–µ—Ä–µ—è —Ä–∞–±–æ—Ç</h4>
              <div class="row mt-3">
                {% for image in gallery %}
                  <div class="col-md-4 gallery-item" data-bs-toggle="modal" data-bs-target="#imageModal" data-image="{{ image.image.url }}" data-description="{{ image.description|default:'–ë–µ–∑ –æ–ø–∏—Å–∞–Ω–∏—è' }}">
                    <img src="{{ image.image.url }}" alt="{{ image.description|default:'–†–∞–±–æ—Ç–∞' }}">
                    <p>{{ image.description|default:"–ë–µ–∑ –æ–ø–∏—Å–∞–Ω–∏—è" }}</p>
                  </div>
                {% endfor %}
              </div>
            {% else %}
              <p class="text-center">–ì–∞–ª–µ—Ä–µ—è –ø—É—Å—Ç–∞.</p>
            {% endif %}
          </div>
        </div>
      {% else %}
        <p class="text-center">–ü—Ä–æ—Ñ–∏–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω.</p>
      {% endif %}
    </div>

    <!-- –°–µ–∫—Ü–∏—è: –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –ø—Ä–æ—Ñ–∏–ª—è -->
    <div id="edit-profile" class="content-section">
      <div class="beauty-form">
        <h3 class="text-center mb-4">–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –ø—Ä–æ—Ñ–∏–ª—å</h3>
        {% if is_client %}
          <form id="edit-client-profile-form" method="post">
            {% csrf_token %}
            {{ client_form.as_p }}
            <button type="submit" class="btn btn-primary btn-lg w-100 mt-3">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
          </form>
        {% elif is_workshop %}
          <form id="edit-workshop-profile-form" method="post">
            {% csrf_token %}
            <fieldset class="mb-4">
              <legend>–î–µ—Ç–∞–ª–∏ –ø—Ä–æ—Ñ–∏–ª—è</legend>
              {{ workshop_form.workshop_name|as_crispy_field }}
              {{ workshop_form.workshop_address|as_crispy_field }}
              {{ workshop_form.city|as_crispy_field }}
              {{ workshop_form.email|as_crispy_field }}
            </fieldset>
            <fieldset class="mb-4">
              <legend>–°—Ñ–µ—Ä—ã –¥–µ—è—Ç–µ–ª—å–Ω–æ—Å—Ç–∏</legend>
              <div class="row">
                {% for category, areas in workshop_form.grouped_activity.items %}
                  <div class="col-md-4 mb-3">
                    <div class="card">
                      <div class="card-header">
                        <div class="form-check">
                          <input type="checkbox" id="select_all_{{ category }}" class="select-all" data-category="{{ category }}">
                          <label for="select_all_{{ category }}">{{ category }} <small>(–≤—ã–±—Ä–∞—Ç—å –≤—Å–µ)</small></label>
                        </div>
                      </div>
                      <div class="card-body">
                        {% for area in areas %}
                          <div class="form-check custom-checkbox">
                            <input
                              type="checkbox"
                              name="activity_area"
                              value="{{ area.pk }}"
                              id="area_{{ area.pk }}"
                              class="custom-control-input activity-area"
                              data-category="{{ category }}"
                              {% if area in workshop_form.initial.activity_area %}checked{% endif %}
                            />
                            <label for="area_{{ area.pk }}" class="custom-control-label">
                              {{ area.name }}
                            </label>
                          </div>
                        {% endfor %}
                      </div>
                    </div>
                  </div>
                {% endfor %}
              </div>
            </fieldset>
            <button type="submit" class="btn btn-primary btn-lg w-100 mt-3">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
          </form>
        {% endif %}
        <div id="edit-profile-message" class="error-message"></div>
      </div>
    </div>

    <!-- –°–µ–∫—Ü–∏—è: –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Ü–µ–Ω -->
    {% if is_workshop %}
      <div id="edit-prices" class="content-section">
        <div class="beauty-form">
          <h3 class="text-center mb-4">–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å —Ü–µ–Ω—ã –Ω–∞ —É—Å–ª—É–≥–∏</h3>
          {% if formset.errors or formset.non_form_errors %}
            <div class="alert alert-danger p-2">
              <ul class="errorlist">
                {% for error in formset.non_form_errors %}
                  <li>{{ error }}</li>
                {% endfor %}
                {% for form in formset %}
                  {% for field, errors in form.errors.items %}
                    <li>{{ field }}: {{ errors|join:", " }}</li>
                  {% endfor %}
                {% endfor %}
              </ul>
            </div>
          {% endif %}
          <form method="post" id="service-price-form">
            {% csrf_token %}
            {{ formset.management_form }}
            <div id="service-forms">
              {% for form in formset %}
                <div class="service-form row g-2 align-items-center" data-service-name="{{ form.instance.service_name|default:'' }}">
                  <div class="col-md-3">{{ form.activity_area|as_crispy_field }}</div>
                  <div class="col-md-3">{{ form.service_name|as_crispy_field }}</div>
                  <div class="col-md-2">{{ form.price|as_crispy_field }}</div>
                  <div class="col-md-2">{{ form.duration|as_crispy_field }}</div>
                  <div class="col-md-2 text-center">
                    <button type="button" class="remove-btn">–£–¥–∞–ª–∏—Ç—å</button>
                  </div>
                  {% if form.instance.pk %}
                    {{ form.id }}
                  {% endif %}
                </div>
              {% endfor %}
            </div>
            <button type="button" id="add-service-form" class="add-btn" title="–î–æ–±–∞–≤–∏—Ç—å —É—Å–ª—É–≥—É">+</button>
            <button type="submit" class="btn btn-primary w-100 mt-3">üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
          </form>
          <div id="edit-prices-message" class="error-message"></div>
        </div>
      </div>

      <!-- –°–µ–∫—Ü–∏—è: –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –≤–∏—Ç—Ä–∏–Ω—ã -->
      <div id="edit-showcase" class="content-section">
        <div class="beauty-form">
          <h3 class="text-center mb-4">–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –≤–∏—Ç—Ä–∏–Ω—É</h3>
          {% if showcase_form.errors or showcase_form.non_field_errors %}
            <div class="alert alert-danger">
              <ul class="errorlist">
                {% for error in showcase_form.non_field_errors %}
                  <li>{{ error }}</li>
                {% endfor %}
                {% for field, errors in showcase_form.errors.items %}
                  <li>{{ field }}: {{ errors|join:", " }}</li>
                {% endfor %}
              </ul>
            </div>
          {% endif %}
          <form method="post" id="edit-showcase-form" enctype="multipart/form-data">
            {% csrf_token %}
            <fieldset class="mb-4">
              <legend>–û–±–ª–æ–∂–∫–∞ –≤–∏—Ç—Ä–∏–Ω—ã</legend>
              {{ showcase_form.cover_photo|as_crispy_field }}
            </fieldset>
            <fieldset class="mb-4">
              <legend>–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —Å—Ç—É–¥–∏–∏</legend>
              {{ showcase_form.description|as_crispy_field }}
              {{ showcase_form.phone|as_crispy_field }}
              {{ showcase_form.working_hours|as_crispy_field }}
            </fieldset>
            <button type="submit" class="btn btn-primary btn-lg w-100 mt-3">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
          </form>
          <div id="edit-showcase-message" class="error-message"></div>
        </div>
      </div>
    {% endif %}
  </div>
</div>

<div class="modal fade" id="imageModal" tabindex="-1" aria-labelledby="imageModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="imageModalLabel">–ü—Ä–æ—Å–º–æ—Ç—Ä –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <img src="" alt="–£–≤–µ–ª–∏—á–µ–Ω–Ω–æ–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ" id="modalImage">
        <p id="modalDescription"></p>
      </div>
    </div>
  </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
  // Toggle content sections
  const buttons = document.querySelectorAll('.sidebar a');
  const sections = document.querySelectorAll('.content-section');

  buttons.forEach(button => {
    button.addEventListener('click', function(e) {
      e.preventDefault();
      const sectionId = this.dataset.section;

      // Remove active class from all buttons and sections
      buttons.forEach(btn => btn.classList.remove('active'));
      sections.forEach(section => section.classList.remove('active'));

      // Add active class to clicked button and corresponding section
      this.classList.add('active');
      document.getElementById(sectionId).classList.add('active');
    });
  });

  // Function to handle AJAX form submission
  function submitForm(formId, messageDivId, successCallback) {
    const form = document.getElementById(formId);
    const messageDiv = document.getElementById(messageDivId);

    form.addEventListener('submit', function(e) {
      e.preventDefault();
      const formData = new FormData(form);

      fetch(form.action, {
        method: 'POST',
        body: formData,
        headers: {
          'X-CSRFToken': '{{ csrf_token }}'
        }
      })
      .then(response => response.json())
      .then(data => {
        if (data.success) {
          messageDiv.innerHTML = '<div class="alert alert-success">–î–∞–Ω–Ω—ã–µ —É—Å–ø–µ—à–Ω–æ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã!</div>';
          if (successCallback) {
            successCallback(data);
          }
          setTimeout(() => {
            messageDiv.innerHTML = '';
            // Switch back to profile details
            buttons.forEach(btn => btn.classList.remove('active'));
            sections.forEach(section => section.classList.remove('active'));
            document.querySelector('.profile-btn[data-section="profile-details"]').classList.add('active');
            document.getElementById('profile-details').classList.add('active');
          }, 2000);
        } else {
          messageDiv.innerHTML = '<div class="alert alert-danger">' + (data.errors || '–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞.') + '</div>';
        }
      })
      .catch(error => {
        messageDiv.innerHTML = '<div class="alert alert-danger">–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞: ' + error.message + '</div>';
      });
    });
  }

  // Edit Profile Form
  {% if is_client %}
    submitForm('edit-client-profile-form', 'edit-profile-message', function(data) {
      // Update profile details
      document.querySelector('#profile-details .card-body p:nth-child(1)').innerHTML = '<strong>–ò–º—è:</strong> ' + (data.name || '{{ user.username }}');
      document.querySelector('#profile-details .card-body p:nth-child(2)').innerHTML = '<strong>Email:</strong> ' + data.email;
      document.querySelector('#profile-details .card-body p:nth-child(3)').innerHTML = '<strong>–¢–µ–ª–µ—Ñ–æ–Ω:</strong> ' + data.phone;
      document.querySelector('#profile-details .card-body p:nth-child(4)').innerHTML = '<strong>–ì–æ—Ä–æ–¥:</strong> ' + (data.city || '–ù–µ —É–∫–∞–∑–∞–Ω–æ');
    });
  {% elif is_workshop %}
    submitForm('edit-workshop-profile-form', 'edit-profile-message', function(data) {
      // Update profile details
      document.querySelector('#profile-details .card-body p:nth-child(1)').innerHTML = '<strong>–ù–∞–∑–≤–∞–Ω–∏–µ –±—å—é—Ç–∏-—Å—Ç—É–¥–∏–∏:</strong> ' + data.workshop_name;
      document.querySelector('#profile-details .card-body p:nth-child(2)').innerHTML = '<strong>–ê–¥—Ä–µ—Å:</strong> ' + data.workshop_address;
      document.querySelector('#profile-details .card-body p:nth-child(3)').innerHTML = '<strong>–ì–æ—Ä–æ–¥:</strong> ' + (data.city || '–ù–µ —É–∫–∞–∑–∞–Ω–æ');
      document.querySelector('#profile-details .card-body p:nth-child(4)').innerHTML = '<strong>Email:</strong> ' + data.email;
      document.querySelector('#profile-details .card-body p:nth-child(5)').innerHTML = '<strong>–¢–µ–ª–µ—Ñ–æ–Ω:</strong> ' + data.phone;
      document.querySelector('#profile-details .card-body p:nth-child(6)').innerHTML = '<strong>–û–ø–∏—Å–∞–Ω–∏–µ:</strong> ' + (data.description || '–ù–µ —É–∫–∞–∑–∞–Ω–æ');
      document.querySelector('#profile-details .card-body p:nth-child(7)').innerHTML = '<strong>–í—Ä–µ–º—è —Ä–∞–±–æ—Ç—ã:</strong> ' + (data.working_hours || '–ù–µ u–∫–∞–∑–∞–Ω–æ');
      // Update activities
      const activitiesContainer = document.querySelector('#profile-details .card-body .activity-list').parentElement;
      activitiesContainer.innerHTML = '<p><strong>–°—Ñ–µ—Ä—ã –¥–µ—è—Ç–µ–ª—å–Ω–æ—Å—Ç–∏:</strong></p>' + data.activities_html;
    });
  {% endif %}

  {% if is_workshop %}
    // Edit Prices Form
    submitForm('service-price-form', 'edit-prices-message', function(data) {
      // Update prices in profile details
      const pricesContainer = document.querySelector('#profile-details .card-body .price-table').parentElement;
      pricesContainer.innerHTML = '<h4>–£—Å–ª—É–≥–∏ –∏ —Ü–µ–Ω—ã</h4>' + (data.prices_html || '<p>–¶–µ–Ω—ã –Ω–∞ —É—Å–ª—É–≥–∏ –Ω–µ —É–∫–∞–∑–∞–Ω—ã.</p>');
    });

    // Edit Showcase Form
    submitForm('edit-showcase-form', 'edit-showcase-message', function(data) {
      // Update showcase details
      document.querySelector('#profile-details .card-body p:nth-child(6)').innerHTML = '<strong>–û–ø–∏—Å–∞–Ω–∏–µ:</strong> ' + (data.description || '–ù–µ —É–∫–∞–∑–∞–Ω–æ');
      document.querySelector('#profile-details .card-body p:nth-child(5)').innerHTML = '<strong>–¢–µ–ª–µ—Ñ–æ–Ω:</strong> ' + data.phone;
      document.querySelector('#profile-details .card-body p:nth-child(7)').innerHTML = '<strong>–í—Ä–µ–º—è —Ä–∞–±–æ—Ç—ã:</strong> ' + (data.working_hours || '–ù–µ —É–∫–∞–∑–∞–Ω–æ');
    });

    // Service Price Form JavaScript
    const serviceMap = {{ service_map|safe }};
    const activityCodes = {{ activity_codes|safe }};
    const formContainer = document.getElementById('service-forms');
    const addButton = document.getElementById('add-service-form');
    const totalForms = document.querySelector('#id_form-TOTAL_FORMS');
    const maxForms = {{ formset.max_num|default:100 }};
    let formNum = parseInt(totalForms.value);

    function updateServiceChoices(select, serviceSelect) {
      const code = activityCodes[select.value] || '';
      const services = serviceMap[code] || [];
      serviceSelect.innerHTML = '<option value="">---------</option>';
      services.forEach(service => {
        const option = document.createElement('option');
        option.value = service;
        option.text = service;
        serviceSelect.appendChild(option);
      });
      const formDiv = select.closest('.service-form');
      const selectedService = formDiv.dataset.serviceName || '';
      if (selectedService && services.includes(selectedService)) {
        serviceSelect.value = selectedService;
      } else {
        serviceSelect.value = '';
      }
    }

    function updateFormIndices() {
      const forms = Array.from(formContainer.querySelectorAll('.service-form'));
      forms.forEach((form, index) => {
        if (form.style.display === 'none') return;
        form.querySelectorAll('input, select, textarea').forEach(input => {
          if (input.name) {
            input.name = input.name.replace(/form-\d+-/, `form-${index}-`);
            input.id = input.id.replace(/id_form-\d+-/, `id_form-${index}-`);
          }
        });
      });
      totalForms.value = forms.filter(form => form.style.display !== 'none').length;
      formNum = parseInt(totalForms.value);
    }

    function removeForm(event) {
      const formDiv = event.target.closest('.service-form');
      const deleteCheckbox = formDiv.querySelector('input[name$="-DELETE"]');
      if (deleteCheckbox) {
        deleteCheckbox.checked = true;
        formDiv.style.display = 'none';
      } else {
        formDiv.remove();
      }
      updateFormIndices();
    }

    function initializeForm(form) {
      const select = form.querySelector('select[name$="activity_area"]');
      const serviceSelect = form.querySelector('select[name$="service_name"]');
      updateServiceChoices(select, serviceSelect);
      select.addEventListener('change', () => {
        updateServiceChoices(select, serviceSelect);
        form.dataset.serviceName = '';
      });
      const removeBtn = form.querySelector('.remove-btn');
      removeBtn.addEventListener('click', removeForm);
    }

    document.querySelectorAll('.service-form').forEach(initializeForm);

    addButton.addEventListener('click', function() {
      if (formNum >= maxForms) {
        alert('–ú–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —É—Å–ª—É–≥: ' + maxForms);
        return;
      }
      const templateForm = formContainer.querySelector('.service-form:last-child').cloneNode(true);
      templateForm.querySelector('input[name$="-DELETE"]')?.remove();
      templateForm.querySelector('input[name$="-id"]')?.remove();
      templateForm.querySelector('input[name$="price"]').value = '';
      templateForm.querySelector('input[name$="duration"]').value = '';
      templateForm.querySelector('select[name$="service_name"]').innerHTML = '<option value="">---------</option>';
      templateForm.dataset.serviceName = '';
      formContainer.appendChild(templateForm);
      updateFormIndices();
      initializeForm(templateForm);
    });

    // Edit Workshop Profile JavaScript
    document.querySelectorAll('.select-all').forEach(function(selectAll) {
      selectAll.addEventListener('change', function() {
        var category = this.dataset.category;
        var checkboxes = document.querySelectorAll('.activity-area[data-category="' + category + '"]');
        checkboxes.forEach(function(checkbox) {
          checkbox.checked = selectAll.checked;
        });
      });
    });

    // Modal for gallery images in profile details
    document.querySelectorAll('.gallery-item').forEach(item => {
      item.addEventListener('click', function(e) {
        const imageUrl = this.dataset.image;
        const description = this.dataset.description || '–ë–µ–∑ –æ–ø–∏—Å–∞–Ω–∏—è';
        document.getElementById('modalImage').src = imageUrl;
        document.getElementById('modalDescription').textContent = description;
      });
    });
  {% endif %}
});
</script>

<link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
{% endblock %}